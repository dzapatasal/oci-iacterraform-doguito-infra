#cloud-config

packages:
  - git
  - wget
  - curl
  - ca-certificates
  
  # Paquetes base para compilación y sistema
  - unzip
  - libaio1         
  - libnsl2         
  - build-essential 
  - python3         
  - python3-dev     

runcmd:
  - |
    echo "--- INICIO DE INSTALACIÓN Y DESPLIEGUE DOGUITO API (UBUNTU 22.04 ARM64) ---"
    
    # 1. ACTUALIZACIÓN E INSTALACIÓN DE NODE.JS V20
    sleep 30
    apt update -y
    
    echo "Paso 1: Instalando Node.js v20 (LTS)..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
    
    # 2. INSTALACIÓN DE DEPENDENCIAS ORACLE (INSTANT CLIENT BASIC + SDK)
    echo "Paso 2: Instalando dependencias de Oracle Instant Client (V19 ARM64)..."
    
    BASIC_URL="https://download.oracle.com/otn_software/linux/instantclient/1928000/instantclient-basic-linux.arm64-19.28.0.0.0dbru.zip"
    SDK_URL="https://download.oracle.com/otn_software/linux/instantclient/1928000/instantclient-sdk-linux.arm64-19.28.0.0.0dbru.zip"
    
    ZIP_FILE_BASIC="/tmp/instantclient-basic.zip"
    ZIP_FILE_SDK="/tmp/instantclient-sdk.zip"
    
    # Directorio PADRE donde descargamos los ZIPs
    ORACLE_PARENT="/usr/lib/oracle/19/client64/lib"
    
    # Directorio REAL creado por el ZIP (Validado por ti: instantclient_19_28)
    ORACLE_HOME="$ORACLE_PARENT/instantclient_19_28"
    
    mkdir -p $ORACLE_PARENT
    
    # Descargar y extraer en el directorio padre
    curl -L -o $ZIP_FILE_BASIC $BASIC_URL
    unzip -o $ZIP_FILE_BASIC -d $ORACLE_PARENT
    
    curl -L -o $ZIP_FILE_SDK $SDK_URL
    unzip -o $ZIP_FILE_SDK -d $ORACLE_PARENT
    
    # Entramos al directorio REAL para crear los enlaces
    cd $ORACLE_HOME
    ln -s libclntsh.so.19.1 libclntsh.so

    # Configuración global del sistema operativo (ld.so) apuntando al directorio REAL
    echo "$ORACLE_HOME" | sudo tee /etc/ld.so.conf.d/oracle-instantclient.conf
    ldconfig
    
    # 3. CONFIGURACIÓN DE LA WALLET (DB)
    echo "Paso 3: Configurando la Wallet..."
    # Guardamos la Wallet dentro de la estructura correcta
    WALLET_PATH="$ORACLE_HOME/network/admin"
    
    mkdir -p $WALLET_PATH
    
    wget -q -O $WALLET_PATH/Wallet_DOGUITODB.zip https://objectstorage.sa-santiago-1.oraclecloud.com/n/axh7wbsx4kzt/b/bucket-arm/o/Wallet_DOGUITODB.zip
    
    unzip -o $WALLET_PATH/Wallet_DOGUITODB.zip -d $WALLET_PATH/

    # CORRECCIÓN DE PERMISOS (Recursivo desde el padre para cubrir todo)
    echo "Corrigiendo permisos..."
    chown -R ubuntu:ubuntu /usr/lib/oracle
    chmod -R 755 /usr/lib/oracle
    
    # 4. DESPLIEGUE DE LA APLICACIÓN NODE.JS
    echo "Paso 4: Clonando e instalando la aplicación Node.js..."
    APP_DIR="/home/ubuntu/doguito-app"
    
    git clone https://github.com/HarlandLohora/doguito-app.git $APP_DIR
    chown -R ubuntu:ubuntu $APP_DIR
    
    # CRÍTICO: Compilación con las rutas validadas
    sudo -u ubuntu sh -c '
      cd /home/ubuntu/doguito-app
      
      echo "Configurando entorno de compilación..."
      # RUTAS EXACTAS OBTENIDAS DE TU COMANDO FIND:
      export CXXFLAGS="-I/usr/lib/oracle/19/client64/lib/instantclient_19_28/sdk/include"
      export LD_LIBRARY_PATH="/usr/lib/oracle/19/client64/lib/instantclient_19_28"
      export TNS_ADMIN="/usr/lib/oracle/19/client64/lib/instantclient_19_28/network/admin"
      
      echo "--> Forzando actualización de oracledb a versión 6.6.0 (Compatible con ARM64)..."
      npm install oracledb@6.6.0 --save

      echo "Ejecutando npm install..."
      npm install --unsafe-perm --build-from-source
    '
    
    # 5. CONFIGURACIÓN DEL SERVICIO SYSTEMD
    echo "Paso 5: Configurando el servicio SystemD..."
    SERVICE_URL="https://objectstorage.sa-santiago-1.oraclecloud.com/n/axh7wbsx4kzt/b/bucket-arm/o/doguito-site-v4.service"
    SERVICE_FILE="/lib/systemd/system/doguito-site-v4.service"
    
    wget -q -O $SERVICE_FILE $SERVICE_URL
    
    systemctl daemon-reload
    systemctl enable doguito-site-v4.service
    systemctl start doguito-site-v4.service
    
    # 6. CONFIGURACIÓN DEL FIREWALL
    echo "Paso 6: Configurando Firewall..."
    ufw allow 22/tcp
    ufw allow 3000/tcp
    ufw --force enable
    
    echo "--- DESPLIEGUE AUTOMÁTICO COMPLETADO ---"