#cloud-config

# Instalación de paquetes necesarios
packages:
  - git
  - nodejs
  - unzip # Necesario para descomprimir la Wallet
  - wget  # Necesario para descargar archivos
  - alien # Herramienta para convertir RPM a DEB (Necesario para Instant Client en Ubuntu)

runcmd:
  - |
    echo "--- INICIO DE INSTALACIÓN Y DESPLIEGUE DOGUITO API (UBUNTU 22.04) ---"
    
    # 1. ESPERA DE RED
    sleep 60
    apt update -y
    
    # 2. INSTALACIÓN DE DEPENDENCIAS ESPECÍFICAS DE OCI (INSTANT CLIENT)
    echo "Instalando dependencias de Oracle Instant Client..."
    
    # URL del Instant Client (Versión 21, adaptable si se usa otra)
    # Se descarga el paquete RPM genérico, que luego será convertido.
    INSTANT_CLIENT_URL="https://download.oracle.com/otn_software/linux/instantclient/2114000/oracle-instantclient-basic-21.14.0.0.0dbru.x86_64.rpm"
    RPM_FILE="/tmp/oracle-instantclient-basic.rpm"
    
    # 2a. Descargar el RPM
    wget -q -O $RPM_FILE $INSTANT_CLIENT_URL
    
    # 2b. Instalar usando alien (convierte RPM a DEB e instala)
    # '-i' instala y '-c' convierte el paquete.
    alien -i $RPM_FILE
    
    # 3. DESCARGA Y CONFIGURACIÓN DE LA WALLET (DB)
    # La ruta de instalación del Instant Client en Ubuntu suele ser /usr/lib/oracle/21/client64/lib/network/admin
    WALLET_PATH="/usr/lib/oracle/21/client64/lib/network/admin" 
    
    echo "Creando directorio de Wallet y descargando..."
    mkdir -p $WALLET_PATH
    
    # Descargar la Wallet ZIP desde Object Storage
    wget -q -O $WALLET_PATH/Wallet_DOGUITODB.zip https://objectstorage.sa-santiago-1.oraclecloud.com/n/axh7wbsx4kzt/b/bucket-doguito-app/o/Wallet_DOGUITODB.zip
    
    # Descomprimir la Wallet
    echo "Descomprimiendo la Wallet..."
    unzip -o $WALLET_PATH/Wallet_DOGUITODB.zip -d $WALLET_PATH/
    
    # 4. DESPLIEGUE DE LA APLICACIÓN NODE.JS
    APP_DIR="/home/ubuntu/doguito-app"
    
    echo "Clonando el repositorio de Doguito API..."
    git clone https://github.com/HarlandLohora/doguito-app.git $APP_DIR
    
    echo "Instalando dependencias de Node.js..."
    # Ejecutamos npm install dentro del directorio clonado
    cd $APP_DIR
    npm install
    
    # 5. CONFIGURACIÓN DEL SERVICIO SYSTEMD
    SERVICE_URL="https://objectstorage.sa-santiago-1.oraclecloud.com/n/axh7wbsx4kzt/b/bucket-doguito-app/o/doguito-site.service"
    SERVICE_FILE="/lib/systemd/system/doguito-site.service"
    
    echo "Descargando y configurando el servicio SystemD..."
    wget -q -O $SERVICE_FILE $SERVICE_URL
    
    # Recargar SystemD, habilitar y arrancar el servicio
    systemctl daemon-reload
    systemctl enable doguito-site.service
    systemctl start doguito-site.service
    
    # 6. CONFIGURACIÓN DEL FIREWALL INTERNO (UFW)
    echo "Configurando UFW para el puerto 3000..."
    ufw allow 22/tcp
    ufw allow 3000/tcp # Puerto de la API Node.js
    ufw --force enable
    
    echo "--- DESPLIEGUE AUTOMÁTICO DE DOGUITO API COMPLETADO ---"