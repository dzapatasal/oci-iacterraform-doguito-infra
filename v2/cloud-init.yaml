#cloud-config

packages:
  - git
  - unzip
  - wget
  - curl
  - libaio1 # Dependencia de Oracle
  - libnsl2 # Dependencia de Oracle
  - ca-certificates
  - build-essential # Necesario para que npm compile el driver de Oracle

runcmd:
  - |
    echo "--- INICIO DE INSTALACIÓN Y DESPLIEGUE DOGUITO API (UBUNTU 22.04) ---"
    
    # 1. ACTUALIZACIÓN Y NODE.JS V20 (Eliminamos el conflicto de versión)
    sleep 30
    apt update -y
    
    echo "Instalando Node.js v20 (LTS)..."
    curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
    apt-get install -y nodejs
    
    # 2. INSTALACIÓN DE DEPENDENCIAS ORACLE (INSTANT CLIENT)
    echo "Instalando dependencias de Oracle Instant Client..."
    INSTANT_CLIENT_URL="https://download.oracle.com/otn_software/linux/instantclient/2120000/instantclient-basic-linux.x64-21.20.0.0.0dbru.zip"
    ZIP_FILE="/tmp/instantclient-basic.zip"
    ORACLE_LIB_PATH="/usr/lib/oracle/21/client64/lib"
    
    curl -L -o $ZIP_FILE $INSTANT_CLIENT_URL
    
    mkdir -p $ORACLE_LIB_PATH
    unzip -o $ZIP_FILE -d $ORACLE_LIB_PATH
    
    cd $ORACLE_LIB_PATH
    ln -s libclntsh.so.21.1 libclntsh.so
    
    ldconfig # <--- CRÍTICO: Soluciona el error DPI-1047.
    
    # 3. CONFIGURACIÓN DE LA WALLET (DB)
    echo "Configurando la Wallet..."
    WALLET_PATH="/usr/lib/oracle/21/client64/lib/network/admin"
    
    mkdir -p $WALLET_PATH
    
    # Descarga desde tu bucket público
    wget -q -O $WALLET_PATH/Wallet_DOGUITODB.zip https://objectstorage.sa-santiago-1.oraclecloud.com/n/axh7wbsx4kzt/b/bucket-20251120-1839/o/Wallet_DOGUITODB.zip
    
    unzip -o $WALLET_PATH/Wallet_DOGUITODB.zip -d $WALLET_PATH/
    
    # 4. DESPLIEGUE DE LA APLICACIÓN NODE.JS
    echo "Desplegando la aplicación Node.js..."
    APP_DIR="/home/ubuntu/doguito-app"
    
    git clone https://github.com/HarlandLohora/doguito-app.git $APP_DIR
    
    cd $APP_DIR
    npm install --unsafe-perm
    chown -R ubuntu:ubuntu $APP_DIR
    
    # 5. CONFIGURACIÓN DEL SERVICIO SYSTEMD
    echo "Configurando el servicio SystemD..."
    SERVICE_URL="https://objectstorage.sa-santiago-1.oraclecloud.com/n/axh7wbsx4kzt/b/bucket-20251120-1839/o/doguito-site-v2.service"
    SERVICE_FILE="/lib/systemd/system/doguito-site-v2.service"
    
    # Descarga el archivo de servicio corregido desde tu bucket
    wget -q -O $SERVICE_FILE $SERVICE_URL
    
    systemctl daemon-reload
    systemctl enable doguito-site-v2.service
    systemctl start doguito-site-v2.service
    
    # 6. CONFIGURACIÓN DEL FIREWALL (UFW)
    echo "Configurando Firewall..."
    ufw allow 22/tcp
    ufw allow 3000/tcp
    ufw --force enable
    
    echo "--- DESPLIEGUE AUTOMÁTICO COMPLETADO ---"